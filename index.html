<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lua Learning Studio (Mobile)</title>
    <style>
        /* CSS: ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ä‡∏µ‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö */
        :root {
            --bg-color: #1e1e1e;
            --editor-bg: #2d2d2d;
            --output-bg: #252526;
            --primary-text: #d4d4d4;
            --secondary-text: #a0a0a0;
            --accent-color: #007acc;
            --error-color: #f44747;
            --success-color: #4CAF50;
            --info-color: #f0e68c; /* Khaki for AI */
            --font-family: Consolas, 'Courier New', monospace;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            touch-action: manipulation;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #ai-tutor {
            padding: 10px 15px;
            background-color: var(--output-bg);
            border-bottom: 1px solid #444;
            font-size: 0.9em;
        }
        #ai-tutor .title { font-weight: bold; color: var(--info-color); }

        #script-manager {
            display: flex;
            align-items: center;
            background-color: #333;
            padding: 5px;
            overflow-x: auto;
        }
        #script-tabs { display: flex; flex-grow: 1; }
        .tab {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-right: 4px;
            background-color: var(--editor-bg);
            color: var(--secondary-text);
            white-space: nowrap;
            border: 1px solid transparent;
        }
        .tab.active {
            background-color: var(--bg-color);
            color: var(--primary-text);
            border-color: #444;
            border-bottom-color: transparent;
        }
        #add-script-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1.2em;
            cursor: pointer;
            flex-shrink: 0;
        }

        #editor-container {
            flex-grow: 1;
            display: flex;
            position: relative;
        }
        #code-editor {
            width: 100%;
            height: 100%;
            padding: 10px;
            background-color: var(--bg-color);
            color: var(--primary-text);
            border: none;
            outline: none;
            font-family: var(--font-family);
            font-size: 16px;
            line-height: 1.5;
            resize: none;
        }

        /* --- NEW: Autocomplete Popup --- */
        #autocomplete-popup {
            position: absolute;
            background-color: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            min-width: 150px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            color: var(--primary-text);
        }
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .autocomplete-item:hover, .autocomplete-item.selected {
            background-color: var(--accent-color);
        }
        .hidden { display: none; }
        /* --- END NEW --- */

        #controls {
            padding: 10px;
            background-color: var(--output-bg);
            display: flex;
            gap: 10px;
        }
        #run-button {
            flex-grow: 1;
            padding: 12px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- NEW: Clear Button --- */
        #clear-output-btn {
            padding: 12px 15px;
            background-color: #5a5a5a;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
        }
        /* --- END NEW --- */


        #output-chat {
            height: 200px;
            background-color: var(--output-bg);
            padding: 10px;
            overflow-y: auto;
            border-top: 1px solid #444;
            font-family: var(--font-family);
            font-size: 0.9em;
        }
        .output-line { padding: 4px 0; white-space: pre-wrap; word-break: break-all; }
        .output-line.error { color: var(--error-color); }
        .output-line.success { color: var(--success-color); }
        .output-line.info { color: var(--secondary-text); }
        .output-line.print { color: #87ceeb; }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="ai-tutor">
            <span class="title">üí° AI Tutor:</span>
            <span id="ai-tip">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥...</span>
        </div>
        <div id="script-manager">
            <div id="script-tabs"></div>
            <button id="add-script-btn">+</button>
        </div>
        <div id="editor-container">
            <textarea id="code-editor" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
            <div id="autocomplete-popup" class="hidden"></div>
        </div>
        <div id="controls">
            <button id="run-button">‚ñ∂Ô∏è Run</button>
            <button id="clear-output-btn" title="Clear Output">üóëÔ∏è</button>
        </div>
        <div id="output-chat">
            <div class="output-line info">-- Output ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà --</div>
        </div>
    </div>

    <script src="https://unpkg.com/fengari-web@0.1.4/dist/fengari-web.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Elements ---
            const aiTipElement = document.getElementById('ai-tip');
            const codeEditor = document.getElementById('code-editor');
            const runButton = document.getElementById('run-button');
            const outputChat = document.getElementById('output-chat');
            const scriptTabsContainer = document.getElementById('script-tabs');
            const addScriptButton = document.getElementById('add-script-btn');
            const clearOutputBtn = document.getElementById('clear-output-btn'); // New
            const autocompletePopup = document.getElementById('autocomplete-popup'); // New

            // --- State Management ---
            let scripts = [
                { name: 'Script', code: '-- ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î Lua ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\nprint("‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‡πÇ‡∏•‡∏Å!")\n\n-- ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Part ‡πÉ‡∏ô Workspace ‡∏à‡∏≥‡∏•‡∏≠‡∏á\nlocal myPart = game.Workspace:Create("Part")\nmyPart.Name = "MyCoolPart"\nmyPart.Position = {x=10, y=5, z=0}' },
                { name: 'LocalScript', code: '-- LocalScript ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Workspace ‡πÑ‡∏î‡πâ\n\nlocal coolPart = game.Workspace:FindFirstChild("MyCoolPart")\n\nif coolPart then\n  print("‡πÄ‡∏à‡∏≠ Part ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤: " .. coolPart.Name)\n  print("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á Part ‡∏Ñ‡∏∑‡∏≠ x=" .. coolPart.Position.x)\nelse\n  print("‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ Part ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠ MyCoolPart!")\nend' }
            ];
            let activeScriptIndex = 0;

            // --- AI Tutor Simulation ---
            const aiTips = [
                "‡πÉ‡∏ä‡πâ 'print()' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ local ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡πÉ‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå", "‡πÉ‡∏ä‡πâ '--' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå", "'game' ‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á", "Workspace ‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö Object ‡πÉ‡∏ô‡πÄ‡∏Å‡∏°", "‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ :Create('ClassName')", "‡πÉ‡∏ä‡πâ :FindFirstChild() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Object ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢", "‡∏Å‡∏î Tab ‡∏´‡∏£‡∏∑‡∏≠ Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÇ‡∏Ñ‡πâ‡∏î"
            ];
            setInterval(() => {
                aiTipElement.textContent = aiTips[Math.floor(Math.random() * aiTips.length)];
            }, 10000);

            // --- UI Functions ---
            function renderTabs() { /* ... (same as before) ... */ 
                scriptTabsContainer.innerHTML = '';
                scripts.forEach((script, index) => {
                    const tab = document.createElement('div');
                    tab.className = 'tab' + (index === activeScriptIndex ? ' active' : '');
                    tab.textContent = script.name;
                    tab.onclick = () => switchScript(index);
                    scriptTabsContainer.appendChild(tab);
                });
            }
            function switchScript(index) { /* ... (same as before) ... */ 
                scripts[activeScriptIndex].code = codeEditor.value;
                activeScriptIndex = index;
                codeEditor.value = scripts[index].code;
                renderTabs();
            }
            function addScript() { /* ... (same as before) ... */ 
                const newName = `Script${scripts.length + 1}`;
                scripts.push({ name: newName, code: `-- ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà: ${newName}` });
                switchScript(scripts.length - 1);
            }
            
            // --- Output Functions ---
            function clearOutput() { /* ... (same as before) ... */
                outputChat.innerHTML = ''; 
            }
            function logToOutput(message, type = 'info') { /* ... (same as before) ... */
                const line = document.createElement('div');
                line.className = `output-line ${type}`;
                line.textContent = message;
                outputChat.appendChild(line);
                outputChat.scrollTop = outputChat.scrollHeight;
            }
            
            // --- NEW: Clear Button Logic ---
            clearOutputBtn.addEventListener('click', () => {
                clearOutput();
                logToOutput('-- Output cleared --', 'info');
            });

            // --- NEW: Autocomplete Logic ---
            const autocompleteKeywords = {
                global: ['local', 'function', 'if', 'then', 'else', 'elseif', 'end', 'for', 'while', 'do', 'return', 'print', 'game', 'true', 'false', 'nil'],
                game: ['Workspace'],
                Workspace: ['Create', 'FindFirstChild'],
                Part: ['Name', 'Position', 'Parent'] // Example properties
            };
            let autocompleteActive = false;
            let currentSuggestions = [];
            let selectedSuggestionIndex = -1;

            function showAutocomplete(suggestions, left, top) {
                if (suggestions.length === 0) {
                    hideAutocomplete();
                    return;
                }
                autocompletePopup.innerHTML = '';
                suggestions.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.textContent = item;
                    div.onclick = () => applySuggestion(index); // For mobile tap
                    autocompletePopup.appendChild(div);
                });
                
                autocompletePopup.style.left = `${left}px`;
                autocompletePopup.style.top = `${top}px`;
                autocompletePopup.classList.remove('hidden');
                autocompleteActive = true;
                selectedSuggestionIndex = -1;
            }

            function hideAutocomplete() {
                autocompletePopup.classList.add('hidden');
                autocompleteActive = false;
            }

            function updateSelectedSuggestion() {
                const items = autocompletePopup.children;
                for (let i = 0; i < items.length; i++) {
                    items[i].classList.toggle('selected', i === selectedSuggestionIndex);
                }
            }
            
            function applySuggestion(index) {
                if (index < 0 || index >= currentSuggestions.length) return;

                const suggestion = currentSuggestions[index];
                const { value, selectionStart } = codeEditor;
                
                let startIndex = selectionStart - 1;
                while(startIndex >= 0 && value[startIndex].match(/[\w\.]/)) {
                    startIndex--;
                }
                startIndex++;
                
                const textBefore = value.substring(0, startIndex);
                const textAfter = value.substring(selectionStart);

                codeEditor.value = textBefore + suggestion + textAfter;
                codeEditor.selectionStart = codeEditor.selectionEnd = textBefore.length + suggestion.length;
                hideAutocomplete();
            }

            // Simple function to get cursor coords in textarea
            function getCursorCoords() {
                const dummy = document.createElement('div');
                const styles = window.getComputedStyle(codeEditor);
                for(const prop of styles) {
                    dummy.style[prop] = styles[prop];
                }
                dummy.style.position = 'absolute';
                dummy.style.visibility = 'hidden';
                dummy.style.height = 'auto';

                const text = codeEditor.value.substring(0, codeEditor.selectionStart);
                dummy.textContent = text;
                
                const span = document.createElement('span');
                span.textContent = codeEditor.value.substring(codeEditor.selectionStart) || '.';
                dummy.appendChild(span);

                document.body.appendChild(dummy);
                const { offsetLeft, offsetTop, clientHeight } = span;
                document.body.removeChild(dummy);

                return {
                    left: offsetLeft + codeEditor.offsetLeft - codeEditor.scrollLeft + 10,
                    top: offsetTop + codeEditor.offsetTop - codeEditor.scrollTop + clientHeight + 5
                };
            }

            codeEditor.addEventListener('input', () => {
                const { value, selectionStart } = codeEditor;
                if (selectionStart === 0) { hideAutocomplete(); return; }

                let lastDot = value.lastIndexOf('.', selectionStart - 1);
                let lastSpace = Math.max(value.lastIndexOf(' ', selectionStart - 1), value.lastIndexOf('\n', selectionStart - 1));
                
                const start = Math.max(lastDot, lastSpace) + 1;
                const currentWord = value.substring(start, selectionStart);

                let context = 'global';
                if (lastDot > lastSpace) {
                    let contextStart = Math.max(value.lastIndexOf(' ', lastDot -1), value.lastIndexOf('\n', lastDot-1)) + 1;
                    context = value.substring(contextStart, lastDot);
                    // This is a simplified context check
                    if (context.endsWith("Workspace")) context = "Workspace";
                    else if (context.endsWith("game")) context = "game";
                }

                if (!currentWord) { hideAutocomplete(); return; }

                currentSuggestions = (autocompleteKeywords[context] || []).filter(k => k.toLowerCase().startsWith(currentWord.toLowerCase()));

                if (currentSuggestions.length > 0) {
                    const coords = getCursorCoords();
                    showAutocomplete(currentSuggestions, coords.left, coords.top);
                } else {
                    hideAutocomplete();
                }
            });

            codeEditor.addEventListener('keydown', (e) => {
                if (!autocompleteActive) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedSuggestionIndex = (selectedSuggestionIndex + 1) % currentSuggestions.length;
                    updateSelectedSuggestion();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedSuggestionIndex = (selectedSuggestionIndex - 1 + currentSuggestions.length) % currentSuggestions.length;
                    updateSelectedSuggestion();
                } else if (e.key === 'Tab' || e.key === 'Enter') {
                    e.preventDefault();
                    applySuggestion(selectedSuggestionIndex > -1 ? selectedSuggestionIndex : 0);
                } else if (e.key === 'Escape') {
                    hideAutocomplete();
                }
            });

            codeEditor.addEventListener('blur', hideAutocomplete);


            // --- Core Lua Execution Logic ---
            runButton.addEventListener('click', () => {
                /* ... (this whole section is the same as before) ... */
                scripts[activeScriptIndex].code = codeEditor.value;
                clearOutput();
                logToOutput("> Starting execution...", "info");
                try {
                    const L = fengari.lauxlib.luaL_newstate();
                    fengari.lualib.luaL_openlibs(L);
                    const mockGame = { Workspace: { _children: {}, Create: function(className) { const newObj = { ClassName: className, Name: className, Position: {x:0, y:0, z:0}, Parent: this, }; this._children[className] = newObj; logToOutput(`[‡∏à‡∏≥‡∏•‡∏≠‡∏á] ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó '${className}' ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏ô Workspace`, 'success'); this.registerFunctions(); return newObj; }, FindFirstChild: function(name) { for(let key in this._children) { if(this._children[key].Name === name) { return this._children[key]; } } return null; }, registerFunctions: function() { fengari.lua.lua_pushjs(L, this.Create.bind(this)); fengari.lua.lua_setfield(L, -2, fengari.to_luastring("Create")); fengari.lua.lua_pushjs(L, this.FindFirstChild.bind(this)); fengari.lua.lua_setfield(L, -2, fengari.to_luastring("FindFirstChild")); } } };
                    fengari.lua.lua_createtable(L, 0, 1); fengari.lua.lua_createtable(L, 0, 2); fengari.lua.lua_createtable(L, 0, 0); fengari.lua.lua_setfield(L, -2, fengari.to_luastring("_children")); mockGame.Workspace.registerFunctions(); fengari.lua.lua_setfield(L, -2, fengari.to_luastring("Workspace")); fengari.lua.lua_setglobal(L, fengari.to_luastring("game"));
                    fengari.lua.lua_pushjs(L, (...args) => { const message = args.map(arg => fengari.to_jsstring(arg)).join('\t'); logToOutput(message, 'print'); logToOutput(`[‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢] ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á print() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: "${message}"`, 'info'); });
                    fengari.lua.lua_setglobal(L, fengari.to_luastring("print"));
                    let allScriptsOk = true;
                    for (const script of scripts) {
                        logToOutput(`--- Running ${script.name} ---`, 'info');
                        const status = fengari.lauxlib.luaL_dostring(L, fengari.to_luastring(script.code));
                        if (status !== fengari.lua.LUA_OK) { const errorMsg = fengari.to_jsstring(fengari.lua.lua_tostring(L, -1)); const lineMatch = errorMsg.match(/\[string "..."\]:(\d+):/); const lineNumber = lineMatch ? lineMatch[1] : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö"; logToOutput(`[ERROR] ‡πÉ‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå '${script.name}' ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà ${lineNumber}:`, 'error'); logToOutput(errorMsg.split(':').slice(2).join(':').trim(), 'error'); allScriptsOk = false; break; }
                    }
                    if(allScriptsOk) { logToOutput("> Execution finished successfully.", "success"); }
                } catch (e) { logToOutput("[FATAL ERROR] ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î:", "error"); logToOutput(e.message, "error"); }
            });

            // --- Initial Setup ---
            aiTipElement.textContent = aiTips[0];
            addScriptButton.onclick = addScript;
            switchScript(0);

        });
    </script>
</body>
</html>
