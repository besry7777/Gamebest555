:root {
    --bg-color: #2e2e2e; --panel-bg: #252526; --editor-bg: #1e1e1e;
    --primary-text: #d4d4d4; --secondary-text: #a0a0a0; --accent-color: #007acc;
    --error-color: #f44747; --success-color: #4CAF50; --info-color: #f0e68c;
    --font-family: Consolas, 'Courier New', monospace;
    --hl-keyword: #569cd6; --hl-string: #ce9178; --hl-number: #b5cea8;
    --hl-comment: #6a9955; --hl-global: #4fc1ff;
}

/* base */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background-color: var(--bg-color); color: var(--primary-text);
    touch-action: manipulation; overflow: hidden;
}

/* layout */
#main-layout { display: flex; height: 100vh; min-height: 0; }

/* Explorer panel
   - fixed: allow full collapse by overriding children min-width when collapsed
   - add min-width:0 to avoid flex-basis overflow when collapsed
*/
#explorer-panel {
    width: 240px;
    background-color: var(--panel-bg);
    display: flex;
    flex-direction: column;
    border-right: 1px solid #444;
    flex-shrink: 0;
    transition: width 0.3s ease, opacity 0.2s ease;
    position: relative;
    min-width: 240px; /* default */
}

/* collapsed state - truly hide children and set width 0 */
#explorer-panel.collapsed {
    width: 0;
    min-width: 0;
    border-right: none;
    overflow: hidden;
    opacity: 0;
    pointer-events: none;
}
#explorer-panel.collapsed > * { min-width: 0; display: none; }

/* ensure children normally keep a minimum, but won't prevent collapse */
#explorer-panel > * { min-width: 240px; }

/* header */
.panel-header {
    padding: 8px 10px;
    font-weight: bold;
    background-color: #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.header-controls button {
    background: none; border: none;
    color: var(--secondary-text); cursor: pointer;
    font-size: 1.2em; padding: 0 5px;
}
.header-controls button:disabled { color: #555; cursor: not-allowed; }

/* explorer toggle button (for reopened panel)
   - display only when explorer-panel is collapsed
   - support both adjacent sibling and general sibling to be robust
*/
#explorer-toggle-btn.collapsed-btn {
    position: fixed; top: 5px; left: 5px; z-index: 2000;
    background: #444; border-radius: 4px; color: white;
    border: none; padding: 6px 8px; display: none; cursor: pointer;
}
/* If #explorer-panel is immediate previous sibling */
#explorer-panel.collapsed + #main-content #explorer-toggle-btn.collapsed-btn { display: block; }
/* Or if it's a later sibling (more robust) */
#explorer-panel.collapsed ~ #main-content #explorer-toggle-btn.collapsed-btn { display: block; }

/* explorer content */
#explorer-content {
    flex-grow: 1; overflow-y: auto; padding: 10px;
    font-family: var(--font-family); font-size: 0.9em;
    min-width: 0; /* prevent overflow */
}
.explorer-item {
    padding: 4px; white-space: nowrap; border-radius: 3px;
    display: flex; align-items: center; justify-content: space-between;
    user-select: none;
}
.explorer-item.selected { background-color: #094771; }
.explorer-item:not(.selected).renameable:hover { background-color: #3a3a3a; }
.explorer-item span { padding: 2px 4px; flex-grow: 1; overflow: hidden; text-overflow: ellipsis; }
.explorer-item[data-depth='1'] { padding-left: 15px; } .explorer-item[data-depth='2'] { padding-left: 30px; }
.explorer-item::before { font-family: monospace; content: 'üìÑ'; margin-right: 5px; }
.explorer-item[data-type='Workspace']::before { content: 'üåç'; } .explorer-item[data-type='ServerScriptService']::before { content: '‚öôÔ∏è'; }
.explorer-item[data-type='ReplicatedStorage']::before { content: 'üì¶'; } .explorer-item[data-type='Part']::before { content: 'üß±'; }
.explorer-item[data-type='Script']::before { content: 'üìú'; } .explorer-item[data-type='RemoteEvent']::before { content: '‚ö°'; }

/* rename input: prevent overflow, flexible width */
.explorer-item-input {
    background: #555; border: 1px solid var(--accent-color);
    color: white; font: inherit; outline: none;
    width: auto; max-width: calc(100% - 60px); padding: 2px 6px;
}

/* add child button: appears on hover or selected */
.add-child-btn {
    display: none; background-color: var(--accent-color); color: white;
    border: none; border-radius: 3px; cursor: pointer; font-size: 1.1em;
    padding: 0 5px; margin-left: 10px;
}
.explorer-item:hover .add-child-btn, .explorer-item.selected .add-child-btn { display: inline-block; }

/* add item menu */
#add-item-menu {
    display: none; position: absolute; background: #3c3c3c;
    border: 1px solid #555; border-radius: 4px; z-index: 1500; padding: 5px;
}
#add-item-menu ul { list-style: none; margin: 0; padding: 0; } 
#add-item-menu li { padding: 8px 12px; cursor: pointer; white-space: nowrap; }
#add-item-menu li:hover { background-color: var(--accent-color); }

/* main content */
#main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; min-width: 0; }

/* ai tutor */
#ai-tutor { padding: 10px 15px; background-color: var(--panel-bg); border-bottom: 1px solid #444; font-size: 0.9em; flex-shrink: 0; }
#ai-tutor .title { font-weight: bold; color: var(--info-color); }

/* script manager / tabs */
#script-manager { display: flex; align-items: center; background-color: #333; padding: 5px; overflow-x: auto; flex-shrink: 0;}
#script-tabs { display: flex; flex-grow: 1; min-width: 0; }
.tab {
    padding: 8px 12px; cursor: pointer; border-radius: 4px 4px 0 0; margin-right: 4px;
    background-color: var(--editor-bg); color: var(--secondary-text); white-space: nowrap;
    border: 1px solid transparent; position: relative; padding-right: 28px;
    max-width: 320px; overflow: hidden; text-overflow: ellipsis;
}
.tab.active {
    background-color: var(--bg-color); color: var(--primary-text);
    border-color: #444 #444 transparent #444;
}
.close-tab-btn {
    position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
    background: none; border: none; color: var(--secondary-text); cursor: pointer;
    font-size: 1.1em; border-radius: 3px; width: 20px; height: 20px;
    line-height: 20px; text-align: center;
}
.tab:hover .close-tab-btn { background-color: #555; }
.tab.active .close-tab-btn { color: var(--primary-text); }

/* editor container and code editor
   - keep highlighting-layer below the textarea (transparent)
   - ensure both layers use same font/line-height for alignment
   - allow scrolling (overflow:auto)
*/
#editor-container { flex-grow: 1; position: relative; background-color: var(--editor-bg); min-width: 0; }

/* both layers must align exactly */
#code-editor, #highlighting-layer-container {
    margin: 0; padding: 10px;
    font-family: var(--font-family); font-size: 16px; line-height: 1.5;
    border: none; outline: none; width: 100%; height: 100%;
    position: absolute; top: 0; left: 0; overflow: auto;
    white-space: pre; word-wrap: normal; -webkit-overflow-scrolling: touch;
}

/* textarea/input layer: transparent text so highlighting shows; caret visible */
#code-editor {
    z-index: 2; background: transparent; color: transparent; caret-color: white; resize: none;
    /* allow selection to show even though text is transparent */
}

/* highlighting layer sits beneath and doesn't capture pointer events */
#highlighting-layer-container { z-index: 1; pointer-events: none; color: var(--primary-text); }

/* error highlight styles */
.syntax-error { text-decoration: underline wavy var(--error-color) 1px; background-color: rgba(244,71,71,0.06); }
.hl-thai-error, .hl-unknown-var { text-decoration: underline wavy var(--error-color) 1px; }

/* autocomplete popup */
#autocomplete-popup {
    position: absolute; background-color: #3c3c3c; border: 1px solid #555; border-radius: 4px;
    min-width: 150px; max-height: 200px; overflow-y: auto; z-index: 1000; color: var(--primary-text);
    box-shadow: 0 6px 18px rgba(0,0,0,0.5);
}
.autocomplete-item { padding: 8px 12px; cursor: pointer; } 
.autocomplete-item:hover, .autocomplete-item.selected { background-color: var(--accent-color); }
.hidden { display: none; }

/* bottom panel and controls */
#bottom-panel { flex-shrink: 0; border-top: 1px solid #444; background: var(--panel-bg); }
#controls { padding: 10px; background-color: var(--panel-bg); display: flex; gap: 10px; align-items: center; }
#run-button {
    flex-grow: 1; padding: 12px; background-color: var(--success-color); color: white;
    border: none; border-radius: 5px; font-size: 1.2em; cursor: pointer; font-weight: bold;
}
.control-btn {
    background-color: #5a5a5a; color: white; border: none; border-radius: 5px;
    font-size: 1.2em; cursor: pointer; padding: 12px 15px;
}
.control-btn:disabled { background-color: #444; color: #777; cursor: not-allowed; }

/* output chat area - ensure scrollable */
#output-chat {
    height: 160px; background-color: var(--panel-bg); padding: 10px; overflow-y: auto;
    font-family: var(--font-family); font-size: 0.9em;
}
.output-line { padding: 4px 0; white-space: pre-wrap; word-break: break-word; }
.output-line.error { color: var(--error-color); } .output-line.success { color: var(--success-color); }
.output-line.info { color: var(--secondary-text); } .output-line.print { color: #87ceeb; }

/* dismiss keyboard for mobile */
#dismiss-keyboard-btn {
    display: none; position: fixed; bottom: 15px; right: 15px; z-index: 2000;
    background: rgba(0,0,0,0.6); color: white; border: 1px solid #888; border-radius: 50%;
    width: 50px; height: 50px; font-size: 1.5em;
}
@media (max-width: 768px) { #dismiss-keyboard-btn.visible { display: block; } }

/* accessibility/focus outlines */
button:focus, .tab:focus, .control-btn:focus, #run-button:focus, .header-controls button:focus {
    outline: 2px solid rgba(0,122,204,0.25); outline-offset: 2px;
}

/* small fixes: ensure scrollbars don't push layout */
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 6px; }

/* responsive tweaks */
@media (max-width: 600px) {
    #explorer-panel { width: 200px; min-width: 200px; }
    #explorer-panel > * { min-width: 200px; }
    #script-tabs .tab { max-width: 180px; }
}