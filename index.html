<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lua Learning Studio (Mobile)</title>
    <style>
        /* CSS: ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ä‡∏µ‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö */
        :root {
            --bg-color: #1e1e1e;
            --editor-bg: #2d2d2d;
            --output-bg: #252526;
            --primary-text: #d4d4d4;
            --secondary-text: #a0a0a0;
            --accent-color: #007acc;
            --error-color: #f44747;
            --success-color: #4CAF50;
            --info-color: #f0e68c; /* Khaki for AI */
            --font-family: Consolas, 'Courier New', monospace;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏™‡∏á‡∏ß‡∏≤‡∏ö‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Double-tap to zoom ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            touch-action: manipulation;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* ‡πÉ‡∏ä‡πâ vh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
            overflow: hidden;
        }

        /* ‡∏™‡πà‡∏ß‡∏ô AI Tutor */
        #ai-tutor {
            padding: 10px 15px;
            background-color: var(--output-bg);
            border-bottom: 1px solid #444;
            font-size: 0.9em;
        }
        #ai-tutor .title {
            font-weight: bold;
            color: var(--info-color);
        }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå (‡πÅ‡∏ó‡πá‡∏ö) */
        #script-manager {
            display: flex;
            align-items: center;
            background-color: #333;
            padding: 5px;
            overflow-x: auto;
        }
        #script-tabs {
            display: flex;
            flex-grow: 1;
        }
        .tab {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-right: 4px;
            background-color: var(--editor-bg);
            color: var(--secondary-text);
            white-space: nowrap;
            border: 1px solid transparent;
        }
        .tab.active {
            background-color: var(--bg-color);
            color: var(--primary-text);
            border-color: #444;
            border-bottom-color: transparent;
        }
        #add-script-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1.2em;
            cursor: pointer;
            flex-shrink: 0;
        }

        /* ‡∏™‡πà‡∏ß‡∏ô Code Editor */
        #editor-container {
            flex-grow: 1;
            display: flex;
            position: relative;
        }
        #code-editor {
            width: 100%;
            height: 100%;
            padding: 10px;
            background-color: var(--bg-color);
            color: var(--primary-text);
            border: none;
            outline: none;
            font-family: var(--font-family);
            font-size: 16px;
            line-height: 1.5;
            resize: none;
        }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏∏‡πà‡∏° Run */
        #controls {
            padding: 10px;
            background-color: var(--output-bg);
        }
        #run-button {
            width: 100%;
            padding: 12px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
            font-weight: bold;
        }

        /* ‡∏™‡πà‡∏ß‡∏ô Output Chat */
        #output-chat {
            height: 200px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á output */
            background-color: var(--output-bg);
            padding: 10px;
            overflow-y: auto;
            border-top: 1px solid #444;
            font-family: var(--font-family);
            font-size: 0.9em;
        }
        .output-line {
            padding: 4px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .output-line.error { color: var(--error-color); }
        .output-line.success { color: var(--success-color); }
        .output-line.info { color: var(--secondary-text); }
        .output-line.print { color: #87ceeb; /* SkyBlue */ }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="ai-tutor">
            <span class="title">üí° AI Tutor:</span>
            <span id="ai-tip">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥...</span>
        </div>

        <div id="script-manager">
            <div id="script-tabs"></div>
            <button id="add-script-btn">+</button>
        </div>
        
        <div id="editor-container">
            <textarea id="code-editor" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
        </div>

        <div id="controls">
            <button id="run-button">‚ñ∂Ô∏è Run</button>
        </div>

        <div id="output-chat">
            <div class="output-line info">-- Output ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà --</div>
        </div>
    </div>

    <script src="https://unpkg.com/fengari-web@0.1.4/dist/fengari-web.js"></script>

    <script>
        // JavaScript: ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Elements ---
            const aiTipElement = document.getElementById('ai-tip');
            const codeEditor = document.getElementById('code-editor');
            const runButton = document.getElementById('run-button');
            const outputChat = document.getElementById('output-chat');
            const scriptTabsContainer = document.getElementById('script-tabs');
            const addScriptButton = document.getElementById('add-script-btn');

            // --- State Management ---
            let scripts = [
                { name: 'Script', code: '-- ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î Lua ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\nprint("‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‡πÇ‡∏•‡∏Å!")\n\n-- ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Part ‡πÉ‡∏ô Workspace ‡∏à‡∏≥‡∏•‡∏≠‡∏á\nlocal myPart = game.Workspace:Create("Part")\nmyPart.Name = "MyCoolPart"\nmyPart.Position = {x=10, y=5, z=0}' },
                { name: 'LocalScript', code: '-- LocalScript ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Workspace ‡πÑ‡∏î‡πâ\n\nlocal coolPart = game.Workspace:FindFirstChild("MyCoolPart")\n\nif coolPart then\n  print("‡πÄ‡∏à‡∏≠ Part ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤: " .. coolPart.Name)\n  print("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á Part ‡∏Ñ‡∏∑‡∏≠ x=" .. coolPart.Position.x)\nelse\n  print("‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ Part ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠ MyCoolPart!")\nend' }
            ];
            let activeScriptIndex = 0;

            // --- AI Tutor Simulation ---
            const aiTips = [
                "‡πÉ‡∏ô Lua, 'print()' ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô Output",
                "‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ local ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡πÉ‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏°‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô",
                "‡πÉ‡∏ä‡πâ '--' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏£‡∏±‡∏ô",
                "Roblox ‡∏°‡∏µ 'game' ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏Å‡∏°",
                "Workspace ‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö Object ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÄ‡∏Å‡∏°",
                "‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ :Create(\"ClassName\")",
                "‡πÉ‡∏ä‡πâ :FindFirstChild() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Object ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î error ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠"
            ];
            let currentTipIndex = 0;
            setInterval(() => {
                currentTipIndex = (currentTipIndex + 1) % aiTips.length;
                aiTipElement.textContent = aiTips[currentTipIndex];
            }, 10000); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

            // --- UI Functions ---
            function renderTabs() {
                scriptTabsContainer.innerHTML = '';
                scripts.forEach((script, index) => {
                    const tab = document.createElement('div');
                    tab.className = 'tab' + (index === activeScriptIndex ? ' active' : '');
                    tab.textContent = script.name;
                    tab.onclick = () => switchScript(index);
                    scriptTabsContainer.appendChild(tab);
                });
            }

            function switchScript(index) {
                // Save current code before switching
                scripts[activeScriptIndex].code = codeEditor.value;

                activeScriptIndex = index;
                codeEditor.value = scripts[index].code;
                renderTabs();
            }

            function addScript() {
                const newName = `Script${scripts.length + 1}`;
                scripts.push({ name: newName, code: `-- ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà: ${newName}` });
                switchScript(scripts.length - 1);
            }

            // --- Output Functions ---
            function clearOutput() {
                outputChat.innerHTML = '';
            }

            function logToOutput(message, type = 'info') {
                const line = document.createElement('div');
                line.className = `output-line ${type}`;
                line.textContent = message;
                outputChat.appendChild(line);
                outputChat.scrollTop = outputChat.scrollHeight; // Auto-scroll to bottom
            }

            // --- Core Lua Execution Logic ---
            runButton.addEventListener('click', () => {
                // Save the currently active script before running
                scripts[activeScriptIndex].code = codeEditor.value;

                clearOutput();
                logToOutput("> Starting execution...", "info");

                try {
                    // 1. Initialize Lua Environment
                    const L = fengari.lauxlib.luaL_newstate();
                    fengari.lualib.luaL_openlibs(L);
                    
                    // 2. Create Mock Roblox Environment
                    const mockGame = {
                        Workspace: {
                            _children: {},
                            Create: function(className) {
                                const newObj = {
                                    ClassName: className,
                                    Name: className,
                                    Position: {x:0, y:0, z:0},
                                    Parent: this,
                                };
                                this._children[className] = newObj; // Use className as a temporary unique key
                                logToOutput(`[‡∏à‡∏≥‡∏•‡∏≠‡∏á] ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó '${className}' ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏ô Workspace`, 'success');
                                // We need to re-register the FindFirstChild function to capture the new object
                                this.registerFunctions();
                                return newObj;
                            },
                            FindFirstChild: function(name) {
                                for(let key in this._children) {
                                    if(this._children[key].Name === name) {
                                        return this._children[key];
                                    }
                                }
                                return null;
                            },
                            // A function to re-register JS functions into Lua context
                            registerFunctions: function() {
                                fengari.lua.lua_pushjs(L, this.Create.bind(this));
                                fengari.lua.lua_setfield(L, -2, fengari.to_luastring("Create"));
                                fengari.lua.lua_pushjs(L, this.FindFirstChild.bind(this));
                                fengari.lua.lua_setfield(L, -2, fengari.to_luastring("FindFirstChild"));
                            }
                        }
                    };
                    
                    // Convert JS object to Lua table and set as global 'game'
                    fengari.lua.lua_createtable(L, 0, 1); // game table
                    fengari.lua.lua_createtable(L, 0, 2); // Workspace table
                    
                    // Add children table to Workspace
                    fengari.lua.lua_createtable(L, 0, 0);
                    fengari.lua.lua_setfield(L, -2, fengari.to_luastring("_children"));

                    mockGame.Workspace.registerFunctions();
                    
                    fengari.lua.lua_setfield(L, -2, fengari.to_luastring("Workspace")); // Set Workspace in game
                    fengari.lua.lua_setglobal(L, fengari.to_luastring("game"));

                    // 3. Override 'print' function
                    fengari.lua.lua_pushjs(L, (...args) => {
                        const message = args.map(arg => fengari.to_jsstring(arg)).join('\t');
                        logToOutput(message, 'print');
                        logToOutput(`[‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢] ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á print() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: "${message}"`, 'info');
                    });
                    fengari.lua.lua_setglobal(L, fengari.to_luastring("print"));

                    // 4. Execute all scripts in order
                    let allScriptsOk = true;
                    for (const script of scripts) {
                        logToOutput(`--- Running ${script.name} ---`, 'info');
                        const status = fengari.lauxlib.luaL_dostring(L, fengari.to_luastring(script.code));
                        
                        if (status !== fengari.lua.LUA_OK) {
                            const errorMsg = fengari.to_jsstring(fengari.lua.lua_tostring(L, -1));
                            const lineMatch = errorMsg.match(/\[string "..."\]:(\d+):/);
                            const lineNumber = lineMatch ? lineMatch[1] : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
                            
                            logToOutput(`[ERROR] ‡πÉ‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå '${script.name}' ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà ${lineNumber}:`, 'error');
                            logToOutput(errorMsg.split(':').slice(2).join(':').trim(), 'error');
                            
                            allScriptsOk = false;
                            break; // Stop execution on first error
                        }
                    }

                    if(allScriptsOk) {
                        logToOutput("> Execution finished successfully.", "success");
                    }

                } catch (e) {
                    logToOutput("[FATAL ERROR] ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î:", "error");
                    logToOutput(e.message, "error");
                }
            });

            // --- Initial Setup ---
            aiTipElement.textContent = aiTips[0];
            addScriptButton.onclick = addScript;
            switchScript(0); // Load the first script initially

        });
    </script>
</body>
</html>
