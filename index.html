<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Full Metadata Report</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap');

    :root {
        /* White Theme & Professional Look */
        --bg-color: #f5f7fa;
        --card-bg: #ffffff;
        --accent: #0056b3; /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ */
        --text-main: #2c3e50;
        --text-label: #546e7a;
        --border-color: #dce4ec;
        --success: #28a745;
    }

    * { box-sizing: border-box; }
    body {
        font-family: 'Sarabun', sans-serif;
        background: var(--bg-color);
        color: var(--text-main);
        margin: 0; padding: 30px;
        display: flex; flex-direction: column; align-items: center;
        min-height: 100vh;
    }

    h1 { margin: 0 0 20px 0; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }

    .btn-upload {
        background: var(--accent); color: white;
        padding: 12px 30px; border-radius: 5px;
        font-size: 16px; font-weight: 600; cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: all 0.2s; border: none;
        display: inline-flex; align-items: center; gap: 10px;
    }
    .btn-upload:hover { background: #004494; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    input[type=file] { display: none; }

    /* --- Report Card Style --- */
    .report-card {
        background: var(--card-bg);
        width: 100%; max-width: 1000px;
        border-radius: 8px; /* ‡∏Ç‡∏≠‡∏ö‡∏°‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ */
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        border: 1px solid var(--border-color);
        padding: 30px; margin-top: 30px;
        display: none;
        grid-template-columns: 400px 1fr; /* Fixed width for left col */
        gap: 30px;
    }
    .report-card.active { display: grid; }

    /* Left Column */
    .visual-evidence { display: flex; flex-direction: column; gap: 20px; }
    .evidence-box {
        border: 1px solid var(--border-color); padding: 10px;
        background: #fcfdfd; border-radius: 4px;
    }
    .evidence-label { font-weight: 700; color: var(--accent); margin-bottom: 8px; display: block; }
    .img-preview { 
        width: 100%; height: 250px; background: #eee; 
        display: flex; justify-content: center; align-items: center;
        overflow: hidden;
    }
    .img-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
    #map { width: 100%; height: 200px; background: #eee; border: 1px solid var(--border-color); }

    /* Right Column: Data Items */
    .data-section { }
    .section-title {
        font-size: 18px; font-weight: 700; color: var(--text-main);
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 10px; margin-bottom: 20px;
        margin-top: 30px; /* Add top margin for subsequent sections */
    }
    .data-section:first-child .section-title { margin-top: 0; }

    .data-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 15px;
    }
    .data-item {
        background: #f8f9fa; border: 1px solid var(--border-color);
        padding: 12px; border-radius: 4px;
    }
    .data-label {
        font-size: 12px; color: var(--text-label); font-weight: 600;
        text-transform: uppercase; margin-bottom: 5px;
    }
    .data-value {
        font-family: 'Roboto Mono', monospace; font-size: 14px;
        color: var(--text-main); word-break: break-word;
    }
    .data-value.highlight { color: var(--accent); font-weight: 600; }

    .full-width { grid-column: 1 / -1; }
    
    .raw-address-list {
        list-style: none; padding: 0; margin: 0;
        font-family: 'Roboto Mono', monospace; font-size: 13px;
    }
    .raw-address-list li {
        padding: 4px 0; border-bottom: 1px dashed var(--border-color);
        display: flex;
    }
    .raw-key { font-weight: 600; color: var(--text-label); min-width: 120px; }
    .raw-val { flex: 1; }

    .footer-note {
        grid-column: 1 / -1;
        text-align: center; margin-top: 30px; padding-top: 20px;
        border-top: 1px solid var(--border-color);
        font-size: 12px; color: var(--text-label);
    }
</style>
</head>
<body>

    <h1>üìÑ Digital Image Metadata Report</h1>
    <label for="upload" class="btn-upload">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Select Image File for Analysis
    </label>
    <input type="file" accept="image/*" id="upload">

    <div class="report-card" id="reportCard">
        
        <div class="visual-evidence">
            <div class="evidence-box">
                <span class="evidence-label">Source Image Preview</span>
                <div class="img-preview"><img id="preview" src=""></div>
            </div>
            <div class="evidence-box">
                <span class="evidence-label">Location Context (GPS)</span>
                <div id="map"></div>
            </div>
        </div>

        <div class="data-section">
            
            <div class="section-title">1. Device & Origin Information</div>
            <div class="data-grid">
                <div class="data-item full-width">
                    <div class="data-label">Make & Model</div>
                    <div class="data-value highlight" id="valModel" style="font-size: 18px;">-</div>
                </div>
                 <div class="data-item full-width">
                    <div class="data-label">Lens Model</div>
                    <div class="data-value" id="valLens">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Software / OS</div>
                    <div class="data-value" id="valSoftware">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Original Date/Time</div>
                    <div class="data-value highlight" id="valDateTime">-</div>
                </div>
            </div>

            <div class="section-title">2. Geographic Location Data</div>
            <div class="data-grid">
                <div class="data-item full-width">
                    <div class="data-label">Derived Address (Readable)</div>
                    <div class="data-value highlight" id="valAddress">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">GPS Coordinates (Decimal)</div>
                    <div class="data-value highlight" id="valGPS_DD">-</div>
                </div>
                 <div class="data-item">
                    <div class="data-label">GPS Coordinates (DMS)</div>
                    <div class="data-value" id="valGPS_DMS" style="font-size: 12px;">-</div>
                </div>
                <div class="data-item full-width">
                    <div class="data-label">Raw Location Data Structure (Nominatim API)</div>
                    <div class="data-value" id="valRawAddress">-</div>
                </div>
            </div>

            <div class="section-title">3. Technical Capture Parameters</div>
             <div class="data-grid" style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));">
                <div class="data-item"><div class="data-label">Aperture (F-Stop)</div><div class="data-value" id="valF">-</div></div>
                <div class="data-item"><div class="data-label">Exposure Time</div><div class="data-value" id="valS">-</div></div>
                <div class="data-item"><div class="data-label">ISO Speed</div><div class="data-value" id="valISO">-</div></div>
                <div class="data-item"><div class="data-label">Focal Length</div><div class="data-value" id="valFL">-</div></div>
                <div class="data-item"><div class="data-label">Focal Length (35mm Eq.)</div><div class="data-value" id="valFL35">-</div></div>
                <div class="data-item"><div class="data-label">Flash Status</div><div class="data-value" id="valFlash">-</div></div>
                <div class="data-item"><div class="data-label">Metering Mode</div><div class="data-value" id="valMetering">-</div></div>
                <div class="data-item"><div class="data-label">White Balance</div><div class="data-value" id="valWB">-</div></div>
                 <div class="data-item"><div class="data-label">Image Resolution</div><div class="data-value" id="valRes">-</div></div>
            </div>

        </div>
         <div class="footer-note">End of Report. Generated via Client-Side EXIF Analysis.</div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map = null, marker = null;

    // Helper: Convert Decimal Deg to Degrees Minutes Seconds
    function toDMS(deg) {
        var d = Math.floor(deg);
        var minfloat = (deg - d) * 60;
        var m = Math.floor(minfloat);
        var s = ((minfloat - m) * 60).toFixed(2);
        return `${d}¬∞ ${m}' ${s}"`;
    }

    function resetReport() {
        const ids = ['valModel', 'valLens', 'valSoftware', 'valDateTime', 'valAddress', 'valGPS_DD', 'valGPS_DMS', 'valRawAddress', 'valF', 'valS', 'valISO', 'valFL', 'valFL35', 'valFlash', 'valMetering', 'valWB', 'valRes'];
        ids.forEach(id => document.getElementById(id).textContent = '-');
        document.getElementById('valModel').textContent = "Analyzing Image File...";
        document.getElementById('valAddress').textContent = "Pending GPS Analysis...";
        if(map && marker) { map.removeLayer(marker); marker = null; }
    }

    document.getElementById('upload').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;

        resetReport();
        document.getElementById('reportCard').classList.add('active');
        const img = document.getElementById('preview');
        img.src = URL.createObjectURL(file);

        img.onload = function () {
            EXIF.getData(img, function () {
                const allTags = EXIF.getAllTags(this);
                // console.log(allTags); // Debug ‡∏î‡∏π tags ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô console

                // 1. Device Info
                let make = EXIF.getTag(this, "Make") || "";
                let model = EXIF.getTag(this, "Model") || "Unknown Device";
                if(model.toLowerCase().includes(make.toLowerCase())) make = "";
                document.getElementById('valModel').textContent = `${make} ${model}`.trim();
                document.getElementById('valLens').textContent = EXIF.getTag(this, "LensModel") || "Not Recorded";
                document.getElementById('valSoftware').textContent = EXIF.getTag(this, "Software") || "Not Recorded";
                document.getElementById('valDateTime').textContent = (EXIF.getTag(this, "DateTimeOriginal") || "-").replace(/:/g, "/");

                // 3. Technical Params
                document.getElementById('valF').textContent = EXIF.getTag(this, "FNumber") ? "f/" + EXIF.getTag(this, "FNumber") : "-";
                let s = EXIF.getTag(this, "ExposureTime");
                document.getElementById('valS').textContent = s ? (s < 1 ? `1/${Math.round(1/s)}` : s) + "s" : "-";
                document.getElementById('valISO').textContent = EXIF.getTag(this, "ISOSpeedRatings") || "-";
                document.getElementById('valFL').textContent = (EXIF.getTag(this, "FocalLength") || "-") + "mm";
                document.getElementById('valFL35').textContent = (EXIF.getTag(this, "FocalLengthIn35mmFilm") || "-") + "mm";
                document.getElementById('valFlash').textContent = EXIF.getTag(this, "Flash") || "-";
                document.getElementById('valMetering').textContent = EXIF.getTag(this, "MeteringMode") || "-";
                document.getElementById('valWB').textContent = EXIF.getTag(this, "WhiteBalance") || "-";
                document.getElementById('valRes').textContent = `${EXIF.getTag(this, "PixelXDimension")||0} x ${EXIF.getTag(this, "PixelYDimension")||0} px`;

                // 2. GPS & Location Data
                const latTag = EXIF.getTag(this, "GPSLatitude");
                const lngTag = EXIF.getTag(this, "GPSLongitude");
                
                if (latTag && lngTag) {
                    const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
                    const lngRef = EXIF.getTag(this, "GPSLongitudeRef") || "E";
                    const latDec = (latTag[0] + latTag[1]/60 + latTag[2]/3600) * (latRef === "S" ? -1 : 1);
                    const lngDec = (lngTag[0] + lngTag[1]/60 + lngTag[2]/3600) * (lngRef === "W" ? -1 : 1);
                    
                    document.getElementById('valGPS_DD').textContent = `${latDec.toFixed(6)}, ${lngDec.toFixed(6)}`;
                    document.getElementById('valGPS_DMS').textContent = `${toDMS(Math.abs(latDec))}${latRef}, ${toDMS(Math.abs(lngDec))}${lngRef}`;

                    // Map Setup
                    if (!map) {
                        map = L.map('map', {zoomControl:false, attributionControl:false});
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); // ‡πÉ‡∏ä‡πâ map ‡∏™‡∏µ‡∏™‡∏ß‡πà‡∏≤‡∏á
                    }
                    map.setView([latDec, lngDec], 15);
                    if(marker) map.removeLayer(marker);
                    marker = L.marker([latDec, lngDec]).addTo(map);
                    setTimeout(() => map.invalidateSize(), 300);

                    // Fetch Reverse Geocoding
                    document.getElementById('valAddress').textContent = "Fetching detailed address...";
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latDec}&lon=${lngDec}&accept-language=th`)
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById('valAddress').textContent = data.display_name || "Address not found";
                            
                            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            if(data.address) {
                                let rawHtml = '<ul class="raw-address-list">';
                                for(const key in data.address) {
                                    rawHtml += `<li><span class="raw-key">${key}:</span><span class="raw-val">${data.address[key]}</span></li>`;
                                }
                                rawHtml += '</ul>';
                                document.getElementById('valRawAddress').innerHTML = rawHtml;
                            }
                        })
                        .catch(err => {
                            document.getElementById('valAddress').textContent = "Error fetching address data.";
                            document.getElementById('valRawAddress').textContent = "Connection failed.";
                        });

                } else {
                    document.getElementById('valAddress').textContent = "No GPS Metadata found in this image.";
                    document.getElementById('valGPS_DD').textContent = "N/A";
                    document.getElementById('valGPS_DMS').textContent = "N/A";
                    document.getElementById('valRawAddress').textContent = "-";
                    if(map) map.setView([0,0], 1);
                }
            });
        };
    });
</script>
</body>
</html>
