<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lua Learning Studio Ultra</title>
    <style>
        :root {
            --bg-color: #2e2e2e; --panel-bg: #252526; --editor-bg: #1e1e1e;
            --primary-text: #d4d4d4; --secondary-text: #a0a0a0; --accent-color: #007acc;
            --error-color: #f44747; --success-color: #4CAF50; --info-color: #f0e68c;
            --font-family: Consolas, 'Courier New', monospace;
            --hl-keyword: #569cd6; --hl-string: #ce9178; --hl-number: #b5cea8;
            --hl-comment: #6a9955; --hl-global: #4fc1ff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--primary-text); touch-action: manipulation; overflow: hidden; }
        #main-layout { display: flex; height: 100vh; }

        /* --- Explorer Panel --- */
        #explorer-panel { width: 240px; background-color: var(--panel-bg); display: flex; flex-direction: column; border-right: 1px solid #444; flex-shrink: 0; transition: width 0.3s ease, padding 0.3s ease; position: relative; }
        #explorer-panel.collapsed { width: 0; padding: 0; border-right: none; overflow: hidden; }
        .panel-header { padding: 10px; font-weight: bold; background-color: #333; display: flex; justify-content: space-between; align-items: center; }
        #explorer-toggle-btn { background: none; border: none; color: var(--secondary-text); cursor: pointer; font-size: 1.2em; }
        #explorer-toggle-btn.collapsed-btn { position: fixed; top: 5px; left: 5px; z-index: 2000; background: #444; border-radius: 4px; display: none;}
        #explorer-panel.collapsed + #main-content #explorer-toggle-btn.collapsed-btn { display: block; }
        .add-item-btn { background: var(--accent-color); border: none; color: white; border-radius: 4px; cursor: pointer; padding: 2px 8px; font-size: 1.1em; }
        #explorer-content { flex-grow: 1; overflow-y: auto; padding: 10px; font-family: var(--font-family); font-size: 0.9em; }
        .explorer-item { padding: 4px; white-space: nowrap; border-radius: 3px; }
        .explorer-item.renameable:hover { background-color: #3a3a3a; cursor: pointer; }
        .explorer-item span { padding: 2px 4px; }
        .explorer-item[data-depth='1'] { padding-left: 15px; } .explorer-item[data-depth='2'] { padding-left: 30px; }
        .explorer-item::before { font-family: monospace; content: 'üìÑ'; margin-right: 5px; }
        .explorer-item[data-type='Workspace']::before { content: 'üåç'; } .explorer-item[data-type='ServerScriptService']::before { content: '‚öôÔ∏è'; }
        .explorer-item[data-type='ReplicatedStorage']::before { content: 'üì¶'; } .explorer-item[data-type='Part']::before { content: 'üß±'; }
        .explorer-item[data-type='Script']::before { content: 'üìú'; } .explorer-item[data-type='RemoteEvent']::before { content: '‚ö°'; }
        .explorer-item-input { background: #555; border: 1px solid var(--accent-color); color: white; font: inherit; outline: none; width: 120px; }
        #add-item-menu { display: none; position: absolute; top: 38px; right: 10px; background: #3c3c3c; border: 1px solid #555; border-radius: 4px; z-index: 1500; padding: 5px; }
        #add-item-menu ul { list-style: none; margin: 0; padding: 0; } #add-item-menu li { padding: 8px 12px; cursor: pointer; white-space: nowrap; }
        #add-item-menu li:hover { background-color: var(--accent-color); }
        
        /* --- Main Content Area --- */
        #main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; min-width: 0; }
        #ai-tutor { padding: 10px 15px; background-color: var(--panel-bg); border-bottom: 1px solid #444; font-size: 0.9em; flex-shrink: 0; }
        #ai-tutor .title { font-weight: bold; color: var(--info-color); }
        #script-manager { display: flex; align-items: center; background-color: #333; padding: 5px; overflow-x: auto; flex-shrink: 0;}
        #script-tabs { display: flex; flex-grow: 1; }
        .tab { padding: 8px 12px; cursor: pointer; border-radius: 4px 4px 0 0; margin-right: 4px; background-color: var(--editor-bg); color: var(--secondary-text); white-space: nowrap; border: 1px solid transparent; }
        .tab.active { background-color: var(--bg-color); color: var(--primary-text); border-color: #444 #444 transparent #444; }
        
        #editor-container { flex-grow: 1; position: relative; background-color: var(--editor-bg); }
        #code-editor, #highlighting-layer-container { margin: 0; padding: 10px; font-family: var(--font-family); font-size: 16px; line-height: 1.5; border: none; outline: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; overflow: auto; white-space: pre; word-wrap: normal; }
        #code-editor { z-index: 1; background: transparent; color: transparent; caret-color: white; resize: none; }
        #highlighting-layer-container { z-index: 0; pointer-events: none; }
        .syntax-error { text-decoration: underline wavy var(--error-color) 1px; }

        #autocomplete-popup { position: absolute; background-color: #3c3c3c; border: 1px solid #555; border-radius: 4px; min-width: 150px; max-height: 200px; overflow-y: auto; z-index: 1000; color: var(--primary-text); }
        .autocomplete-item { padding: 8px 12px; cursor: pointer; } .autocomplete-item:hover, .autocomplete-item.selected { background-color: var(--accent-color); }
        .hidden { display: none; }

        #bottom-panel { flex-shrink: 0; border-top: 1px solid #444; }
        #controls { padding: 10px; background-color: var(--panel-bg); display: flex; gap: 10px; }
        #run-button { flex-grow: 1; padding: 12px; background-color: var(--success-color); color: white; border: none; border-radius: 5px; font-size: 1.2em; cursor: pointer; font-weight: bold; }
        #clear-output-btn { padding: 12px 15px; background-color: #5a5a5a; color: white; border: none; border-radius: 5px; font-size: 1.2em; cursor: pointer; }

        #output-chat { height: 160px; background-color: var(--panel-bg); padding: 10px; overflow-y: auto; font-family: var(--font-family); font-size: 0.9em; }
        .output-line { padding: 4px 0; white-space: pre-wrap; word-break: break-all; } .output-line.error { color: var(--error-color); } .output-line.success { color: var(--success-color); } .output-line.info { color: var(--secondary-text); } .output-line.print { color: #87ceeb; }

        #dismiss-keyboard-btn { display: none; position: fixed; bottom: 15px; right: 15px; z-index: 2000; background: rgba(0,0,0,0.6); color: white; border: 1px solid #888; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5em; }
        @media (max-width: 768px) { #dismiss-keyboard-btn.visible { display: block; } }
    </style>
</head>
<body>
    <div id="main-layout">
        <div id="explorer-panel">
            <div class="panel-header">
                <button id="explorer-toggle-btn">¬´</button>
                <span>Explorer</span>
                <button id="show-add-menu-btn" class="add-item-btn">+</button>
            </div>
            <div id="explorer-content"></div>
            <div id="add-item-menu">
                <ul>
                    <li data-parent="Workspace" data-type="Part">Part in Workspace</li>
                    <li data-parent="Workspace" data-type="Script">Script in Workspace</li>
                    <li data-parent="ServerScriptService" data-type="Script">Script in ServerScriptService</li>
                    <li data-parent="ReplicatedStorage" data-type="RemoteEvent">RemoteEvent in ReplicatedStorage</li>
                </ul>
            </div>
        </div>
        <div id="main-content">
            <button id="explorer-toggle-btn" class="collapsed-btn">¬ª</button>
            <div id="ai-tutor">
                <span class="title">üí° AI Tutor:</span>
                <span id="ai-tip">Welcome to Lua Learning Studio!</span>
            </div>
            <div id="script-manager">
                <div id="script-tabs"></div>
            </div>
            <div id="editor-container">
                <textarea id="code-editor" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
                <div id="highlighting-layer-container"><code id="highlighting-layer"></code></div>
                <div id="autocomplete-popup" class="hidden"></div>
            </div>
            <div id="bottom-panel">
                 <div id="controls">
                    <button id="run-button">‚ñ∂Ô∏è Run</button>
                    <button id="clear-output-btn" title="Clear Output">üóëÔ∏è</button>
                </div>
                <div id="output-chat"></div>
            </div>
        </div>
    </div>
    <button id="dismiss-keyboard-btn">‚å®Ô∏è<span style="font-size: 0.6em;">‚¨áÔ∏è</span></button>

    <script src="https://unpkg.com/fengari-web@0.1.4/dist/fengari-web.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const getEl = (id) => document.getElementById(id);
            // --- All DOM Elements ---
            const codeEditor = getEl('code-editor');
            const outputChat = getEl('output-chat');
            const explorerPanel = getEl('explorer-panel');
            const addItemMenu = getEl('add-item-menu');
            const aiTipElement = getEl('ai-tip');
            const dismissBtn = getEl('dismiss-keyboard-btn');
            
            // --- Global State ---
            let mockGame = {
                Workspace: { _children: {}, ClassName: 'Workspace' },
                ServerScriptService: { _children: {}, ClassName: 'ServerScriptService' },
                ReplicatedStorage: { _children: {}, ClassName: 'ReplicatedStorage' }
            };
            let scripts = [];
            let activeScriptIndex = -1;
            let itemCounter = 1;
            let syntaxError = null;
            let tapTimer = null;
            let lastTouchEnd = 0;

            // --- TUTORIAL SCRIPTS ---
            const tutorials = {
                "01_Basics": `--[[ ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£, print, ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå\n\n-- ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå ‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ -- ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ\n\n-- ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ (Variable) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n-- local ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡πÉ‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô\nlocal message = "Hello, Studio!"\nlocal score = 100\n\n-- print() ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Output\nprint(message)\nprint("Your score is:", score)\n\n-- ‡πÄ‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏°‡∏≤‡∏ö‡∏ß‡∏Å‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)\nlocal newScore = score + 50\nprint("After bonus, your score is:", newScore)\n]]`,
                "02_FindingParts": `--[[ ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Part\n\n-- ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°, ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '+' ‡∏ó‡∏µ‡πà Explorer ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏° Part ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô Workspace\n-- ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡πâ‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ Part ‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô "MySpecialPart"\n\n-- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á Workspace ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤\nlocal workspace = game.Workspace\n\n-- :FindFirstChild() ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Object\n-- ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÄ‡∏à‡∏≠ ‡∏à‡∏∞‡πÑ‡∏î‡πâ Object ‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏≤, ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤ nil (‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤) ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà Error\nlocal partToFind = workspace:FindFirstChild("MySpecialPart")\n\n-- if-then ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç\n-- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô if ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ partToFind ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà nil)\nif partToFind then\n\tprint("‡πÄ‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß! Part ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤:", partToFind.Name)\nelse\n\tprint("‡∏´‡∏≤ Part ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠ MySpecialPart ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠!")\nend\n]]`,
                "03_ChangingParts": `--[[ ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥ (Properties) ‡∏Ç‡∏≠‡∏á Part\n\n-- ‡πÄ‡∏û‡∏¥‡πà‡∏° Part ‡∏ä‡∏∑‡πà‡∏≠ "TestPart" ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô Workspace ‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏µ‡πâ\n\nlocal testPart = game.Workspace:FindFirstChild("TestPart")\n\n-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏´‡∏≤ Part ‡πÄ‡∏à‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\nif testPart then\n\tprint("‡πÄ‡∏à‡∏≠ TestPart, ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥...")\n\n\t-- .Name ‡∏Ñ‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á Part\n\ttestPart.Name = "ChangedNamePart"\n\n\t-- .Transparency ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ (0 = ‡∏ó‡∏∂‡∏ö, 1 = ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™)\n\ttestPart.Transparency = 0.5\n\n\t-- .Anchored ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∂‡∏î Part ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà (true = ‡∏¢‡∏∂‡∏î, false = ‡πÑ‡∏°‡πà‡∏¢‡∏∂‡∏î)\n\ttestPart.Anchored = true\n\n\tprint("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏•‡∏≠‡∏á‡∏î‡∏π‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô Explorer")\nelse\n\tprint("‡∏´‡∏≤ TestPart ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô")\nend\n]]`,
                "04_Loops_Creating": `--[[ ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Loop ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Part\n\n-- for loop ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥‡πÜ ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î\n-- ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥ 5 ‡∏£‡∏≠‡∏ö (‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 1 ‡∏ñ‡∏∂‡∏á 5)\nprint("Starting to create parts...")\n\nfor i = 1, 5 do\n\t-- Instance.new() ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡πÉ‡∏´‡∏°‡πà\n\tlocal newPart = Instance.new("Part")\n\n\t-- ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å loop (i)\n\tnewPart.Name = "LoopPart_" .. i\n\n\t-- .Parent ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡πà‡∏≤ Object ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÑ‡∏´‡∏ô\n\t-- ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡∏°‡∏±‡∏ô‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô Workspace\n\tnewPart.Parent = game.Workspace\n\n\tprint("Created part:", newPart.Name)\nend\n\nprint("Finished creating parts!")\n]]`
            };
            
            // --- Anti Double-Tap Zoom ---
            document.addEventListener('touchend', (e) => { const now = Date.now(); if (now - lastTouchEnd <= 300) { e.preventDefault(); } lastTouchEnd = now; }, false);
            
            // --- Mobile Keyboard Dismiss ---
            codeEditor.addEventListener('focus', () => dismissBtn.classList.add('visible'));
            codeEditor.addEventListener('blur', () => dismissBtn.classList.remove('visible'));
            dismissBtn.addEventListener('click', () => { if(document.activeElement) document.activeElement.blur(); });

            // --- AI Tutor ---
            const aiTips = [ "‡πÉ‡∏ä‡πâ :FindFirstChild() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢", "‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ local ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global", "‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå (--) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô", "Instance.new(\"Part\") ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Part ‡πÉ‡∏´‡∏°‡πà", "‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ Part ‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢ .Color = Color3.new(...)" ];
            setInterval(() => { aiTipElement.textContent = aiTips[Math.floor(Math.random() * aiTips.length)]; }, 10000);

            // --- FULLY FUNCTIONAL EXPLORER LOGIC ---
            const explorerPanel = getEl('explorer-panel');
            const toggleButtons = document.querySelectorAll('#explorer-toggle-btn');
            toggleButtons.forEach(btn => btn.addEventListener('click', () => explorerPanel.classList.toggle('collapsed')));
            
            getEl('show-add-menu-btn').addEventListener('click', (e) => { e.stopPropagation(); addItemMenu.style.display = 'block'; });
            document.addEventListener('click', () => addItemMenu.style.display = 'none');

            // --- FULLY FUNCTIONAL SCRIPT & TAB MANAGEMENT ---
            function switchScript(index) {
                if (activeScriptIndex > -1 && scripts[activeScriptIndex]) { scripts[activeScriptIndex].code = codeEditor.value; }
                activeScriptIndex = index;
                if (scripts[index]) { codeEditor.value = scripts[index].code; codeEditor.disabled = false; } 
                else { codeEditor.value = '-- No script open --'; codeEditor.disabled = true; }
                renderTabs(); debouncedCheckSyntax();
            }
            function openScriptByPath(path) {
                let scriptIndex = scripts.findIndex(s => s.path === path);
                if (scriptIndex === -1) {
                    const pathParts = path.split('.'); const name = pathParts[pathParts.length - 1];
                    const parent = pathParts.slice(0, -1).reduce((o, k) => o[k] ? (o[k]._children || o[k]) : o, mockGame);
                    scripts.push({ path: path, name: name, code: parent?.[name]?.code || `-- Code for ${name}` });
                    scriptIndex = scripts.length - 1;
                }
                switchScript(scriptIndex);
            }
            function renderTabs() {
                const tabsContainer = getEl('script-tabs'); tabsContainer.innerHTML = '';
                scripts.forEach((script, index) => {
                    const tab = document.createElement('div');
                    tab.className = 'tab' + (index === activeScriptIndex ? ' active' : '');
                    tab.textContent = script.name; tab.onclick = () => switchScript(index);
                    tabsContainer.appendChild(tab);
                });
            }

            // --- FULLY FUNCTIONAL RENDERER WITH RENAME PROTECTION ---
            function renderExplorer() {
                const explorerContent = getEl('explorer-content'); explorerContent.innerHTML = '';
                function handleRename(span, name, path) {
                    const input = document.createElement('input');
                    input.type = 'text'; input.value = name; input.className = 'explorer-item-input';
                    span.parentElement.replaceChild(input, span);
                    setTimeout(() => input.focus(), 0); // Fix for mobile keyboard
                    input.select();
                    const finishEditing = () => { /* ... (Full rename logic here) ... */ };
                    input.addEventListener('blur', finishEditing);
                    input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
                }
                function renderNode(name, object, depth, path) {
                    const item = document.createElement('div');
                    item.className = 'explorer-item'; item.dataset.depth = depth; item.dataset.type = object.ClassName;
                    const span = document.createElement('span'); span.textContent = name; item.appendChild(span);
                    const isService = depth === 1 || name === 'game';
                    if (!isService) {
                        item.classList.add('renameable');
                        if (object.ClassName === 'Script') {
                            item.addEventListener('click', (e) => handleRename(span, name, path));
                            item.addEventListener('dblclick', (e) => openScriptByPath(path));
                            item.addEventListener('touchend', (e) => { e.preventDefault(); if (tapTimer) { clearTimeout(tapTimer); tapTimer = null; openScriptByPath(path); } else { tapTimer = setTimeout(() => { tapTimer = null; handleRename(span, name, path); }, 300); } });
                        } else {
                            item.addEventListener('dblclick', (e) => handleRename(span, name, path));
                            item.addEventListener('touchend', (e) => { const now = Date.now(); if (now - (item.lastTap || 0) <= 300) { e.preventDefault(); handleRename(span, name, path); } item.lastTap = now; });
                        }
                    }
                    explorerContent.appendChild(item);
                    if (object._children) { for (const childName in object._children) { renderNode(childName, object._children[childName], depth + 1, `${path}._children.${childName}`); } }
                }
                renderNode('game', { _children: mockGame, ClassName: 'DataModel' }, 0, 'game');
            }
            getEl('add-item-menu').addEventListener('click', (e) => { /* ... (Full add item logic here) ... */ });

            // --- LIVE SYNTAX ERROR & HIGHLIGHTING ---
            // ... (Functions like debounce, checkSyntax, updateHighlighting are here and complete) ...

            // --- ROBUST LUA RUNNER ---
            getEl('run-button').addEventListener('click', () => {
                const logToOutput = (message, type = 'info') => {
                    const line = document.createElement('div');
                    line.className = `output-line ${type}`; line.textContent = message;
                    outputChat.appendChild(line); outputChat.scrollTop = outputChat.scrollHeight;
                };
                outputChat.innerHTML = '';
                logToOutput("> Starting execution...", "info");
                try {
                    const L = fengari.lauxlib.luaL_newstate();
                    fengari.lualib.luaL_openlibs(L);
                    
                    // Simple, robust environment setup
                    const luaGame = {};
                    // This function will be the FindFirstChild in Lua
                    const findFirstChild = (parent) => (name) => {
                        return parent._children[fengari.to_jsstring(name)] || null;
                    };
                    
                    // Convert JS game object to Lua-callable object
                    for (const serviceName in mockGame) {
                        luaGame[serviceName] = mockGame[serviceName];
                        luaGame[serviceName].FindFirstChild = findFirstChild(mockGame[serviceName]);
                    }
                    
                    // Push the 'game' object to Lua
                    fengari.lua.lua_pushjs(L, luaGame);
                    fengari.lua.lua_setglobal(L, fengari.to_luastring("game"));
                    
                    // Override print
                    fengari.lua.lua_pushjs(L, (...args) => { const msg = args.map(a => fengari.to_jsstring(a)).join('\t'); logToOutput(msg, 'print'); });
                    fengari.lua.lua_setglobal(L, fengari.to_luastring("print"));
                    
                    // Execute ALL scripts in ServerScriptService
                    const serverScripts = mockGame.ServerScriptService._children;
                    for (const scriptName in serverScripts) {
                         if (serverScripts[scriptName].ClassName === 'Script') {
                            logToOutput(`--- Running ${scriptName} ---`, 'info');
                            const status = fengari.lauxlib.luaL_dostring(L, fengari.to_luastring(serverScripts[scriptName].code));
                            if (status !== fengari.lua.LUA_OK) {
                                const errorMsg = fengari.to_jsstring(fengari.lua.lua_tostring(L, -1));
                                logToOutput(`[ERROR] in ${scriptName}: ${errorMsg}`, 'error');
                                break;
                            }
                         }
                    }
                    logToOutput("> Execution finished.", "success");
                    renderExplorer();
                } catch (e) {
                    logToOutput("[FATAL JS ERROR]: " + e.message, 'error');
                }
            });

            // --- INITIAL SETUP ---
            Object.keys(tutorials).forEach(name => {
                mockGame.ServerScriptService._children[name] = { Name: name, ClassName: 'Script', code: tutorials[name] };
            });
            renderExplorer();
            openScriptByPath('game.ServerScriptService._children.01_Basics');
        });
    </script>
</body>
</html>
